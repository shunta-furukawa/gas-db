# Sample: GAS + gas-db + HTML (TODO App)

This is a sample project showing how to build a simple TODO list application using:
- [gas-db](https://github.com/your-username/gas-db) (a library for treating Google Sheets like a database)  
- Google Apps Script’s Web App functionality  
- A client-side HTML (served by Apps Script)

**No external hosting (like GitHub Pages) is needed**, because the HTML and JS are served directly from GAS. This avoids CORS issues and simplifies deployment.

## Overview

1. **Google Spreadsheet** – acts as the “database”
2. **`code.js`** – server-side code (GAS). Includes:
   - The `gas-db` usage for CRUD on the spreadsheet
   - Entry point `doGet(e)` which returns `index.html`
   - Functions to fetch/create/update/delete TODO items
3. **`index.html`** – client-side UI, returned by `HtmlService`.  
   - Uses [`google.script.run`](https://developers.google.com/apps-script/guides/html/reference/run) to call server-side functions.

### File Structure

```
.
├── code.js        (GAS server-side code)
├── index.html     (Client-side UI served by GAS)
└── README.md      (This file)
```

---

## Getting Started

Follow these steps to set up and deploy the sample:

### 1. Prepare a Spreadsheet

1. Create a new Google Spreadsheet.
2. Rename a sheet to `Todos` (or any name you like, but make sure it matches in code).
3. Add header columns: `id`, `title`, `completed`
4. Keep the Spreadsheet’s ID for later use (the part in the URL after `/d/` and before `/edit`).

### 2. Create a GAS Project

1. Go to [script.google.com](https://script.google.com/) and create a new project.  
2. (Alternatively, you can use the **Apps Script** editor directly from your Spreadsheet by going to `Extensions` > `Apps Script`.)

### 3. Add the code

1. **Copy** the contents of `code.js` into your Script Project as, for example, `Code.gs`.  
2. **Copy** the contents of `index.html` into your Script Project as an HTML file (named `index.html`).  
3. Within `code.js` (or `Code.gs`):
   - Replace `"YOUR_SPREADSHEET_ID"` with the ID of your actual Spreadsheet.
   - Make sure you also have the `gas-db` code included in your project, or added as a library if you’re using it in library form.

### 4. Deploy as Web App

1. In the Apps Script editor, click **Deploy** → **New deployment**.
2. Select **“Web app”** as the deployment type.
3. Under **“Execute the app as”**, choose **“Me”**.
4. Under **“Who has access”**, select **“Anyone”** (or “Anyone with the link”, depending on your needs).  
   - If you want public access without sign-in, choose “Anyone (anonymous)”.  
5. Click **Deploy**.  
6. Copy the **Web App URL** generated by Apps Script.

### 5. Test

1. Open the Web App URL in your browser.
2. You’ll see a simple TODO list page served directly from GAS.
3. Try adding a new TODO. It should appear instantly.
4. Check your Spreadsheet. A new row should have been added with the `title`, and `completed: false`.

---

## How it works

- **`doGet(e)`** returns `index.html` via `HtmlService`. This is the **web app** entry point.
- Inside `index.html`, the JavaScript calls `google.script.run.<functionName>` to invoke server-side functions (e.g., `getTodos()`, `createTodo()`, `toggleTodo()`, `deleteTodo()`).
- On the server side:
  - `getDb()` creates a new `GasDb` instance pointing to the `Todos` sheet.
  - The CRUD-like functions do the actual reading/writing in your spreadsheet.
- Because everything is served from the same origin (the GAS Web App domain), **CORS is not an issue**.  
- The user interface is updated in real time by re-fetching data (`getTodos()`) after each operation.

---

## Files

### `code.js` (Server-side code)

```javascript
// code.js

/**
 * doGet - main entry point.
 * Serves the 'index.html' template.
 */
function doGet(e) {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle("GAS TODO App");
}

/**
 * Helper to return a new GasDb instance pointing at our spreadsheet.
 */
function getDb() {
  const SPREADSHEET_ID = "YOUR_SPREADSHEET_ID";
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Todos");
  return new GasDb(sheet);
}

/** Fetch all TODOs */
function getTodos() {
  const db = getDb();
  return db.fetchAll().map(r => ({
    id: r.id,
    title: r.title,
    completed: String(r.completed) === "true"
  }));
}

/** Create a new TODO item */
function createTodo(title) {
  const db = getDb();
  const newTodo = {
    id: new Date().getTime(),
    title,
    completed: false
  };
  db.insert(newTodo);
}

/** Toggle a TODO's 'completed' state */
function toggleTodo(id) {
  const db = getDb();
  const todo = db.find({ id: Number(id) });
  if (!todo) return;
  db.update({ id: todo.id }, { completed: !todo.completed });
}

/** Delete a TODO by id */
function deleteTodo(id) {
  const db = getDb();
  db.delete({ id: Number(id) });
}
```

### `index.html` (Client-side UI)

```html
<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GAS TODO App</title>
    <style>
      body { font-family: sans-serif; }
      li.completed { text-decoration: line-through; color: #999; }
      button { margin-left: 8px; }
    </style>
  </head>
  <body>
    <h1>TODO List (GAS Web App)</h1>
    <form id="todoForm">
      <input type="text" id="todoInput" placeholder="New task..." required/>
      <button type="submit">Add</button>
    </form>

    <ul id="todoList"></ul>

    <script>
      // On load, fetch and render the TODO list
      window.addEventListener('DOMContentLoaded', () => {
        fetchTodos();
      });

      // Calls the server-side 'getTodos' function
      function fetchTodos() {
        google.script.run.withSuccessHandler(renderTodos).getTodos();
      }

      // Renders the list in the UL
      function renderTodos(todos) {
        const listEl = document.getElementById('todoList');
        listEl.innerHTML = '';

        todos.forEach(todo => {
          const li = document.createElement('li');
          li.textContent = todo.title;
          if (todo.completed) li.classList.add('completed');

          // Toggle button
          const toggleBtn = document.createElement('button');
          toggleBtn.textContent = todo.completed ? 'Uncheck' : 'Check';
          toggleBtn.addEventListener('click', () => {
            google.script.run.withSuccessHandler(fetchTodos).toggleTodo(todo.id);
          });

          // Delete button
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', () => {
            google.script.run.withSuccessHandler(fetchTodos).deleteTodo(todo.id);
          });

          li.appendChild(toggleBtn);
          li.appendChild(deleteBtn);
          listEl.appendChild(li);
        });
      }

      // Creating a new TODO
      const form = document.getElementById('todoForm');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('todoInput');
        const title = input.value.trim();
        if (!title) return;

        google.script.run.withSuccessHandler(() => {
          fetchTodos();
          input.value = '';
        }).createTodo(title);
      });
    </script>
  </body>
</html>
```

---

## FAQ

### Why not just host the HTML on GitHub Pages?

- When hosting the frontend on a separate domain, we often face [CORS issues](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS).  
- Google Apps Script doesn’t provide a straightforward way to set custom CORS headers (like `Access-Control-Allow-Origin`).  
- By serving `index.html` directly from the same GAS app, we avoid cross-domain requests altogether, so no special CORS handling is needed.

### Can I use gas-db queries or advanced updates?

Yes! `gas-db` offers a variety of methods like `fetchAll`, `query`, `find`, `insert`, `update`, `delete`, etc. Feel free to modify the code to use more complex queries or additional columns in your sheet.

### Do I need to share the Spreadsheet publicly?

- Generally, no. As long as the script is set to run as “Me” (the owner) and the “Who has access” is set to “Anyone”, end users won’t need direct access to the sheet.  
- The script itself handles all read/write operations behind the scenes.

### How do I debug?

- Use `Logger.log()` in your server-side code. Check the logs via the Apps Script editor (`View > Logs`) or in the “Executions” menu.
- `console.log()` in your client code can be seen in the browser’s dev console.


## References

- [gas-db on GitHub](https://github.com/shunta-furukawa/gas-db)
- [Google Apps Script official docs](https://developers.google.com/apps-script/)
- [HtmlService / Web Apps on Apps Script](https://developers.google.com/apps-script/guides/html)
